rm *.o && rm kernel.elf
pkill qemu
echo "cleaned"
clang --target=aarch64-none-elf -c arch/aarch64/vectors.s -o vectors.o

clang --target=aarch64-none-elf -c arch/aarch64/start.s -o start.o
clang --target=aarch64-none-elf -ffreestanding -nostdlib -mgeneral-regs-only -c drivers/char/uart.c core/kmain.c core/mmu.c
/opt/homebrew/opt/llvm@16/bin/ld.lld -T linker.ld start.o kmain.o uart.o mmu.o vectors.o -o kernel.elf

# exit(1)

QEMU_ARGS=(
  -M virt -cpu cortex-a53 -m 4G
  -machine virtualization=off
  -nographic -serial mon:stdio
  -device loader,file=kernel.elf,addr=0x80000000,cpu-num=0
  -d all
  -D qemu-%d.log
  -accel tcg
  -S -gdb tcp::1234
)

# Start QEMU in background
qemu-system-aarch64 "${QEMU_ARGS[@]}" &
QEMU_PID=$!

echo $QEMU_PID > /tmp/test

# Small wait to ensure gdbstub is listening
sleep 0.2

# Launch GDB and connect
gdb -q kernel.elf \
-ex "b _start" \
  -ex "set architecture aarch64" \
  -ex "target remote :1234" 
